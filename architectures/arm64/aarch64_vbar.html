<!DOCTYPE html>
<html class="no-js" lang="en" data-content_root="../../">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>Vector Tables in ARM64 &mdash; Gupje  documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../../_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/dist/theme.css?v=310cf088" />
      <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../_static/drawio.css" />
            <link rel="index" title="Index" href="../../genindex.html" />
            <link rel="search" title="Search" href="../../search.html" />
            <link rel="top" title="Gupje  documentation" href="#" />
    </head>
<body>
    <script type="text/javascript" src="../../_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="/"
                        title="Gupje"
                        class="logo navbar-brand"
                    >
                        <img src="../../_static/img/wagtail-logo-circle.svg" width="45" height="59" alt="Gupje"
                            class="logo-img"
                        />
                        Gupje
                    </a>
                
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="../../search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">Setup:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Gupje overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started.html">Getting Started</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Targets:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../targets/rpi4.html">Raspberry Pi 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../targets/nvidia_shield.html">Nvidia Shield Tablet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../targets/samsung_s7.html">Samsung S7</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architectures:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">ARM64</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm_thumb/index.html">ARM Thumb Mode</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="../../index.html">Docs</a></li>
        <li class="breadcrumb-item active" aria-current="page">Vector Tables in ARM64</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/architectures/arm64/aarch64_vbar.rst" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="../../_sources/architectures/arm64/aarch64_vbar.rst.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="vector-tables-in-arm64">
<h1>Vector Tables in ARM64<a class="headerlink" href="#vector-tables-in-arm64" title="Link to this heading">¶</a></h1>
<p>A lot of this documentation can also be found in the <a class="reference external" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;ved=2ahUKEwitkfqjqNz5AhUJHuwKHZ3vAj4QFnoECBMQAQ&amp;url=https%3A%2F%2Fdocumentation-service.arm.com%2Fstatic%2F5f8ea482f86e16515cdbe3c6%3Ftoken%3D&amp;usg=AOvVaw3QI7Lwrcg6B3BmQ5syZV70">ARM SMC calling convention documentation</a></p>
<section id="vector-exception-levels">
<h2>Vector Exception Levels<a class="headerlink" href="#vector-exception-levels" title="Link to this heading">¶</a></h2>
<p>In ARM64 each there is a Vector table for each Exception level, except for EL0. So, in practice there is a Vector table for:</p>
<blockquote>
<div><ul class="simple">
<li><p>EL3 <code class="docutils literal notranslate"><span class="pre">Secure</span> <span class="pre">Monitor</span> <span class="pre">Call</span> <span class="pre">(SMC)</span></code></p></li>
<li><p>EL2 <code class="docutils literal notranslate"><span class="pre">Hyper</span> <span class="pre">Visor</span> <span class="pre">Call</span> <span class="pre">(HVC)</span></code></p></li>
<li><p>EL1 <code class="docutils literal notranslate"><span class="pre">Super</span> <span class="pre">Visor</span> <span class="pre">Call</span> <span class="pre">(SVC)</span></code></p></li>
</ul>
</div></blockquote>
<p>Documentation about this can be found in <a class="reference external" href="https://developer.arm.com/documentation/100933/0100/AArch64-exception-vector-table">the ARM documentation</a></p>
<img alt="../../_images/vector_table_arm64.png" src="../../_images/vector_table_arm64.png" />
<p>This vector table can be allocated and filled for each of the vector tables described above.</p>
</section>
<section id="setting-the-vector-base-address">
<h2>Setting the Vector Base Address<a class="headerlink" href="#setting-the-vector-base-address" title="Link to this heading">¶</a></h2>
<p>To set the location of this vector table a call <code class="docutils literal notranslate"><span class="pre">MSR</span></code> call can be done to <code class="docutils literal notranslate"><span class="pre">VBAR_ELX</span></code> which will write an address to that register. When an execption call is executed, this address is fetched and execution will move to that page, with the corresponding Execption Level(EL)</p>
</section>
<section id="arm-smc-calling-convention">
<h2>ARM SMC Calling Convention<a class="headerlink" href="#arm-smc-calling-convention" title="Link to this heading">¶</a></h2>
<p>When doing an SMC call in arm64 a synchronous exception is generated that is handled by the secure monitor in EL3.
The SMC call can be in both 32 and 64 bit mode, depending on various bits in the instruction.
For most phones this will be in 64 bit mode.</p>
<p>When doing a SMC call, the register <code class="docutils literal notranslate"><span class="pre">ELR_ELn</span></code> is updated to show the location of where the call came from.
This is the address after the call where the exception came from. When doing an <code class="docutils literal notranslate"><span class="pre">ERET</span></code> instruction this value is written to the <code class="docutils literal notranslate"><span class="pre">PC</span></code>.</p>
<section id="stack-pointers">
<h3>Stack Pointers<a class="headerlink" href="#stack-pointers" title="Link to this heading">¶</a></h3>
<p>Each Exception Level has its own stack pointers. The registers for these are:</p>
<ul class="simple">
<li><p>SP_EL0</p></li>
<li><p>SP_EL1</p></li>
<li><p>SP_EL2</p></li>
<li><p>SP_EL3</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">SP_EL3</span></code> is innacessible in EL3, to read it you need to read the <code class="docutils literal notranslate"><span class="pre">SP</span></code>.</p>
</section>
</section>
</section>
<section id="debugger-vbar-implementation">
<h1>Debugger VBAR Implementation<a class="headerlink" href="#debugger-vbar-implementation" title="Link to this heading">¶</a></h1>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Docs are incomplete!</p>
</div>
<p>The debugger uses a SMC call to insert a breakpoint at any address. When a SMC call is thrown the processor jumps to the address pointed to in the <code class="docutils literal notranslate"><span class="pre">VBAR_EL3</span></code> register.
This register <strong>has to</strong> point to the debugger.
The debugger will first store all the registers in the storage location, overwrite the stack pointer and send the hello message <code class="docutils literal notranslate"><span class="pre">b'GiAs'</span></code> to the host.</p>
<p>An overview of what is happening when a SMC call is dan can be seen below:</p>
<img alt="../../_images/smc_handling_arm64.jpg" src="../../_images/smc_handling_arm64.jpg" />
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently register X15 gets corrupted when an SMC call is handled.</p>
</div>
</section>

</main>
                        
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">Vector Tables in ARM64</a><ul>
<li><a class="reference internal" href="#vector-exception-levels">Vector Exception Levels</a></li>
<li><a class="reference internal" href="#setting-the-vector-base-address">Setting the Vector Base Address</a></li>
<li><a class="reference internal" href="#arm-smc-calling-convention">ARM SMC Calling Convention</a><ul>
<li><a class="reference internal" href="#stack-pointers">Stack Pointers</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#debugger-vbar-implementation">Debugger VBAR Implementation</a></li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                    &copy; Copyright 2024, Eljakim
            </div>
            <div class="text-center text-white-50 font-italic mt-3">
                <small>
                    Created using
                    <a href="https://github.com/wagtail/sphinx_wagtail_theme" rel="nofollow" target="_blank">
                        Sphinx Wagtail Theme 6.4.0
                    </a>
                    and
                    <a href="https://www.sphinx-doc.org/" rel="nofollow" target="_blank">
                        Sphinx 8.1.3
                    </a>
                </small>
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=9bcbadda"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../_static/copybutton.js?v=f281be69"></script>
        <script type="text/javascript" src="../../_static/dist/theme.js"></script>
        <script type="text/javascript" src="../../_static/dist/vendor.js"></script>
        <script type="text/javascript" src="../../_static/searchtools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("../../searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>